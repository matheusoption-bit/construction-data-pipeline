name: Daily BCB Data Ingestion

on:
  # Execu√ß√£o agendada: todos os dias √†s 06:05 BRT (09:05 UTC)
  schedule:
    - cron: '5 9 * * *'
  
  # Permite execu√ß√£o manual via GitHub UI
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  ingest-bcb:
    name: Ingest BCB Series Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # 1. Checkout do c√≥digo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Garante checkout completo
      
      # 1.1. Debug - Verificar vers√£o do c√≥digo
      - name: Verify code version
        run: |
          echo "üìã √öltimo commit:"
          git log --oneline -1
          echo ""
          echo "üìã SERIES_MAP no daily_bcb.py (verifica√ß√£o):"
          grep -A 15 "SERIES_MAP = {" src/jobs/daily_bcb.py || echo "SERIES_MAP n√£o encontrado"
          echo ""
          echo "üìã Verificando se s√©rie 1207 existe:"
          grep "1207" src/jobs/daily_bcb.py && echo "‚ö†Ô∏è ATEN√á√ÉO: S√©rie 1207 ainda est√° no c√≥digo!" || echo "‚úÖ S√©rie 1207 removida corretamente"
      
      # 2. Setup Python 3.11
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # 3. Cache de depend√™ncias pip para acelerar builds
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      # 4. Instalar depend√™ncias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 5. Decodificar credenciais Google (armazenadas como base64 no secret)
      - name: Decode Google credentials
        env:
          GOOGLE_CREDENTIALS_BASE64: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "$GOOGLE_CREDENTIALS_BASE64" | base64 --decode > credentials.json
          echo "‚úì Credentials decoded successfully"
      
      # 6. Configurar vari√°veis de ambiente
      - name: Set environment variables
        run: |
          echo "GOOGLE_SPREADSHEET_ID=${{ secrets.GOOGLE_SPREADSHEET_ID }}" >> $GITHUB_ENV
          echo "GOOGLE_CREDENTIALS_PATH=${{ github.workspace }}/credentials.json" >> $GITHUB_ENV
          echo "TZ=America/Sao_Paulo" >> $GITHUB_ENV
          echo "LOG_LEVEL=INFO" >> $GITHUB_ENV
      
      # 7. Executar job de ingest√£o
      - name: Run BCB data ingestion job
        id: ingestion
        run: |
          echo "Starting BCB data ingestion..."
          python -m src.jobs.daily_bcb
          echo "‚úì Job completed successfully"
      
      # 8. Upload logs em caso de falha
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ingestion-logs-${{ github.run_number }}
          path: |
            *.log
            **/*.log
          retention-days: 7
          if-no-files-found: ignore
      
      # 9. Limpar credenciais (seguran√ßa)
      - name: Cleanup credentials
        if: always()
        run: |
          rm -f credentials.json
          echo "‚úì Credentials cleaned up"
      
      # 10. Notificar falha na issue #1
      - name: Notify failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = `## ‚ùå Daily BCB Ingestion Failed
            
            **Workflow Run:** [#${context.runNumber}](${runUrl})
            **Triggered by:** ${context.eventName}
            **Timestamp:** ${new Date().toISOString()}
            
            Please check the logs and investigate the failure.
            
            [View Logs](${runUrl})`;
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 1,
                body: body
              });
              console.log('‚úì Failure notification posted to issue #1');
            } catch (error) {
              console.log('‚ö† Could not post to issue #1:', error.message);
              console.log('This is expected if issue #1 does not exist');
            }
